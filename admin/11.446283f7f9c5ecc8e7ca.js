(window.webpackJsonp=window.webpackJsonp||[]).push([[11],{"Gw/Z":function(e,t,s){"use strict";s.r(t),s.d(t,"MessagesModule",function(){return Y});var i=s("vTDv"),n=s("tyNb"),o=s("mrSG"),r=s("ofXK"),a=s("3Pt+"),c=s("XNiG"),l=s("fXoL"),h=s("HDdC"),d=s("D0XW"),m=s("Y7HM");function g(e){const{subscriber:t,counter:s,period:i}=e;t.next(s),this.schedule({subscriber:t,counter:s+1,period:i},i)}var u=s("2Vo4"),b=s("JX91"),p=s("lJxs"),f=s("Cfvw"),v=s("zx2A");function y(e,t){return t?s=>s.pipe(y((s,i)=>Object(f.a)(e(s,i)).pipe(Object(p.a)((e,n)=>t(s,e,i,n))))):t=>t.lift(new C(e))}class C{constructor(e){this.project=e}call(e,t){return t.subscribe(new D(e,this.project))}}class D extends v.b{constructor(e,t){super(e),this.project=t,this.hasSubscription=!1,this.hasCompleted=!1,this.index=0}_next(e){this.hasSubscription||this.tryNext(e)}tryNext(e){let t;const s=this.index++;try{t=this.project(e,s)}catch(i){return void this.destination.error(i)}this.hasSubscription=!0,this._innerSub(t)}_innerSub(e){const t=new v.a(this),s=this.destination;s.add(t);const i=Object(v.c)(e,t);i!==t&&s.add(i)}_complete(){this.hasCompleted=!0,this.hasSubscription||this.destination.complete(),this.unsubscribe()}notifyNext(e){this.destination.next(e)}notifyError(e){this.destination.error(e)}notifyComplete(){this.hasSubscription=!1,this.hasCompleted&&this.destination.complete()}}var w=s("vkgz"),S=s("EWl0"),M=s("tk/3"),O=s("ytdW"),I=s("I/3d");let x=(()=>{class e{constructor(e,t,s,i){this.datePipe=e,this.httpClient=t,this.tokenService=s,this.firestore=i}sendMessage(e,t,s){const i={msg:{message:t},sender:s,sentDate:this.datePipe.transform(new Date,"yyyy-MM-dd HH:mm:ss","TZD").toString()};this.firestore.collection("chat_rooms").doc(e).collection("messages").add(i)}requestGetMessages(e){if(e){let t;return console.log("getMessagesObservable is run"),function(e=0,t=d.a){return(!Object(m.a)(e)||e<0)&&(e=0),t&&"function"==typeof t.schedule||(t=d.a),new h.a(s=>(s.add(t.schedule(g,e,{subscriber:s,counter:0,period:e})),s))}(2e3).pipe(Object(b.a)(0),y(()=>this.firestore.collection("chat_rooms").doc(e).collection("messages").get().pipe(Object(w.a)(e=>(t||(console.log("size is undefined : ",t),this.chatMessages=new u.a(e)),console.log(t,e.size),e.size>t&&(console.log("there is new message"),this.chatMessages.next(e)),t=e.size,e))))).toPromise()}}sendNotificationToReportFromAdmin(e){return this.httpClient.post(S.a.notificationToReportAPI,{roomID:e},this.tokenService.httpOptions())}sendNotificationToCaptainFromAdmin(e){return this.httpClient.post(S.a.notificationtoCaptainAPI,{roomID:e},this.tokenService.httpOptions())}notificationToOwnerFromAdmin(e){return this.httpClient.post(S.a.notificationToOwnerAPI,{roomID:e},this.tokenService.httpOptions())}}return e.\u0275fac=function(t){return new(t||e)(l.cc(r.e),l.cc(M.a),l.cc(O.a),l.cc(I.a))},e.\u0275prov=l.Pb({token:e,factory:e.\u0275fac,providedIn:"root"}),e})();var P=s("W9AH"),k=s("ijy7"),G=s("5eHb"),_=s("sYmb");function R(e,t){if(1&e&&(l.Wb(0),l.Yb(1,"p",12),l.Dc(2),l.Ub(3,"br"),l.Yb(4,"span",13),l.Dc(5),l.ic(6,"date"),l.Xb(),l.Xb(),l.Vb()),2&e){const e=l.hc().$implicit;l.Gb(2),l.Fc(" ",null!=e&&null!=e.msg&&e.msg.message?null==e||null==e.msg?null:e.msg.message:null==e?null:e.msg,""),l.Gb(3),l.Ec(l.kc(6,2,null!=e&&null!=e.sentDate&&e.sentDate.seconds?null==e||null==e.sentDate?null:e.sentDate.seconds:null==e?null:e.sentDate,"h:mm a"))}}function T(e,t){if(1&e&&(l.Wb(0),l.Yb(1,"p",14),l.Dc(2),l.Ub(3,"br"),l.Yb(4,"span",13),l.Dc(5),l.ic(6,"date"),l.Xb(),l.Xb(),l.Vb()),2&e){const e=l.hc().$implicit;l.Gb(2),l.Fc(" ",null!=e&&null!=e.msg&&e.msg.message?null==e||null==e.msg?null:e.msg.message:null==e?null:e.msg,""),l.Gb(3),l.Ec(l.kc(6,2,null!=e&&null!=e.sentDate&&e.sentDate.seconds?null==e||null==e.sentDate?null:e.sentDate.seconds:null==e?null:e.sentDate,"h:mm a"))}}function F(e,t){if(1&e&&(l.Wb(0),l.Cc(1,R,7,5,"ng-container",11),l.Cc(2,T,7,5,"ng-container",11),l.Vb()),2&e){const e=t.$implicit,s=l.hc();l.Gb(1),l.oc("ngIf",e.sender==s.secondSender),l.Gb(1),l.oc("ngIf",e.sender==s.firstSender)}}let X=(()=>{class e{constructor(e,t,s,i,n,o,r,a){this.messageService=e,this.captainService=t,this.orderService=s,this.formBuilder=i,this.toaster=n,this.render=o,this.document=r,this.activatedRoute=a,this.destroy$=new c.a}ngOnInit(){this.isReportChat=!1,this.isCaptainChat=!1,this.checkMessageBodyScrollHeight(),this.messageForm=this.formBuilder.group({message:["",a.q.required],roomId:[""]}),this.activatedRoute.params.subscribe(e=>"owner"==e.client?(this.isOwnerChat=!0,this.roomID=e.uuid,this.runRequestGetMessages(e.uuid).then(),this.getMessages()):("captain"==e.client&&this.captainService.captainDetails(Number(e.id)).subscribe(e=>{if(console.log("Captain Room ID",e.Data.uuid),e.Data.uuid)return this.isCaptainChat=!0,this.roomID=e.Data.uuid,this.runRequestGetMessages(e.Data.uuid).then(),this.getMessages()}),"order"==e.client&&this.orderService.orderDetails(Number(e.id)).subscribe(e=>{if(e.Data.uuid)return console.log("Order Room ID : ",e.Data.uuid),this.roomID=e.Data.uuid,this.runRequestGetMessages(e.Data.uuid).then(),this.getMessages()}),"report"==e.client?(console.log("Report Room ID : ",e.uuid),this.isReportChat=!0,this.roomID=e.uuid,this.runRequestGetMessages(e.uuid).then(),this.getMessages()):void 0))}runRequestGetMessages(e){return Object(o.a)(this,void 0,void 0,function*(){e&&(this.messageForm.get("roomId").setValue(e),yield this.messageService.requestGetMessages(e))})}getMessages(){const e=setInterval(()=>{this.messageService.chatMessages&&(clearInterval(e),this.messageService.chatMessages.subscribe(e=>{if(console.log("messages: ",e),e&&(this.messages=[],e.docs.forEach((e,t)=>{this.messages.push(e.data())}),this.messages.sort((e,t)=>e.sentDate.localeCompare(t.sentDate)),this.messages.length>0)){this.secondSender="admin";for(let e=0;e<this.messages.length;e++)null==this.firstSender&&this.messages[e].sender!=this.secondSender&&(this.firstSender=this.messages[e].sender)}},e=>console.log("Error ",e),()=>{if(this.messages.sort((e,t)=>e.sentDate.localeCompare(t.sentDate)),console.log("after sort Messages : ",this.messages),this.messages.length>0){this.secondSender="admin";for(let e=0;e<this.messages.length-1;e++)null==this.firstSender&&this.messages[e].sender!=this.secondSender&&(this.firstSender=this.messages[e].sender);console.log("firstSender : ",this.firstSender),console.log("secondSender : ",this.secondSender)}}))},1e3)}checkMessageBodyScrollHeight(){this.bodyScrollHeightInterval=setInterval(()=>{const e=this.document.querySelector(".messages-body");e.scrollHeight>40&&(e.scrollTop=e.scrollHeight,clearInterval(this.bodyScrollHeightInterval))},100)}checkMessageDirectionForRtl(){{const e=setInterval(()=>{const t=this.document.querySelector(".messages-body");t.scrollHeight>40&&(t.scrollTop=t.scrollHeight,clearInterval(e))},100)}}ngOnDestroy(){clearInterval(this.bodyScrollHeightInterval),this.isReportChat=!1,this.isCaptainChat=!1,this.isOwnerChat=!1,this.destroy$.next(),this.destroy$.complete()}onSubmit(){if(this.messageForm.valid){console.log("roomID : ",this.roomID);const e=this.messageForm.getRawValue();this.isReportChat&&this.messageService.sendNotificationToReportFromAdmin(this.roomID).subscribe(e=>console.log("send notification : ",e)),this.isCaptainChat&&this.messageService.sendNotificationToCaptainFromAdmin(this.roomID).subscribe(e=>console.log("send notification : ",e)),this.isOwnerChat&&this.messageService.notificationToOwnerFromAdmin(this.roomID).subscribe(e=>console.log("send notification : ",e)),console.log(e),e.roomId?this.messageService.sendMessage(e.roomId,e.message,"admin"):this.toaster.error("Error, Please Try Later"),this.messageForm.reset(),this.getMessages()}else this.toaster.error("Error : Can't Send An Empty Message")}}return e.\u0275fac=function(t){return new(t||e)(l.Tb(x),l.Tb(P.a),l.Tb(k.a),l.Tb(a.b),l.Tb(G.b),l.Tb(l.K),l.Tb(r.d),l.Tb(n.a))},e.\u0275cmp=l.Nb({type:e,selectors:[["app-chat"]],decls:17,vars:12,consts:[[1,"messages"],[1,"container"],[1,"bg-light-blue","text-white","font-weight-bold","p-3"],[1,"col-12","col-md-8","mx-auto","border","mt-4"],[1,"messages-body","my-3","pt-3","p-2"],[4,"ngFor","ngForOf"],[1,"",3,"formGroup","ngSubmit"],[1,"input-group","mb-3"],["type","text","name","message","formControlName","message","aria-label","Type here","aria-describedby","basic-addon2",1,"form-control",3,"placeholder"],[1,"input-group-append"],["type","submit",1,"btn","btn-primary",3,"disabled"],[4,"ngIf"],[1,"col-12","col-sm-11","col-md-10","recieved-message","text-white","py-1","px-2","rounded","bg-grey-blue","ml-custom-auto"],[1,"message-time"],[1,"col-12","col-sm-11","col-md-10","recieved-message","text-white","py-1","px-2","rounded","bg-light-blue","mr-custom-auto"]],template:function(e,t){1&e&&(l.Yb(0,"div",0),l.Yb(1,"div",1),l.Yb(2,"h1",2),l.Dc(3),l.ic(4,"translate"),l.Xb(),l.Yb(5,"div",3),l.Yb(6,"div",4),l.Cc(7,F,3,2,"ng-container",5),l.Xb(),l.Ub(8,"div"),l.Yb(9,"form",6),l.fc("ngSubmit",function(){return t.onSubmit()}),l.Yb(10,"div",7),l.Ub(11,"input",8),l.ic(12,"translate"),l.Yb(13,"div",9),l.Yb(14,"button",10),l.Dc(15),l.ic(16,"translate"),l.Xb(),l.Xb(),l.Xb(),l.Xb(),l.Xb(),l.Xb(),l.Xb()),2&e&&(l.Gb(3),l.Ec(l.jc(4,6,"chat-room")),l.Gb(4),l.oc("ngForOf",t.messages),l.Gb(2),l.oc("formGroup",t.messageForm),l.Gb(2),l.pc("placeholder",l.jc(12,8,"type-here")),l.Gb(3),l.oc("disabled",!t.messageForm.valid),l.Gb(1),l.Ec(l.jc(16,10,"send")))},directives:[r.l,a.s,a.i,a.f,a.a,a.h,a.d,r.m],pipes:[_.c,r.e],styles:["@media (min-width:992px) and (max-width:1199px){.messages[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{font-size:2.2rem}}@media (min-width:768px) and (max-width:991px){.messages[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{font-size:2rem}}@media (min-width:576px) and (max-width:767px){.messages[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{font-size:2rem;background:none!important;color:#21a5b8!important}}@media (max-width:575px){.messages[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{font-size:1.8rem;background:none!important;color:#21a5b8!important}}.messages-body[_ngcontent-%COMP%]{height:70vh;max-height:70vh;overflow-y:scroll;direction:ltr}.messages-body[_ngcontent-%COMP%]::-webkit-scrollbar{width:4px}.messages-body[_ngcontent-%COMP%]::-webkit-scrollbar-track{background:#f1f1f1}.messages-body[_ngcontent-%COMP%]::-webkit-scrollbar-thumb{background:#ccc}.messages-body[_ngcontent-%COMP%]::-webkit-scrollbar-thumb:hover{background:#aaa}.messages-body[_ngcontent-%COMP%]   .recieved-message[_ngcontent-%COMP%]{width:-webkit-max-content;width:max-content}.messages-body[_ngcontent-%COMP%]   .recieved-message[_ngcontent-%COMP%]   .message-time[_ngcontent-%COMP%]{font-size:.7rem;font-weight:100}"]}),e})();const j=[{path:"view/:client/:id",component:X},{path:"view/:client/:id/:uuid",component:X}];let H=(()=>{class e{}return e.\u0275mod=l.Rb({type:e}),e.\u0275inj=l.Qb({factory:function(t){return new(t||e)},imports:[[n.e.forChild(j)],n.e]}),e})(),Y=(()=>{class e{}return e.\u0275mod=l.Rb({type:e}),e.\u0275inj=l.Qb({factory:function(t){return new(t||e)},providers:[x,r.e],imports:[[i.a,H]]}),e})()}}]);