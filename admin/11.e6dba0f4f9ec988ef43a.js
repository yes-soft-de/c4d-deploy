(window.webpackJsonp=window.webpackJsonp||[]).push([[11],{"Gw/Z":function(e,s,t){"use strict";t.r(s),t.d(s,"MessagesModule",function(){return R});var n=t("vTDv"),o=t("tyNb"),i=t("ofXK"),r=t("3Pt+"),a=t("XNiG"),c=t("fXoL"),l=t("HDdC"),d=t("D0XW"),m=t("Y7HM");function h(e){const{subscriber:s,counter:t,period:n}=e;s.next(t),this.schedule({subscriber:s,counter:t+1,period:n},n)}var g=t("2Vo4"),u=t("JX91"),b=t("eIep"),p=t("vkgz"),f=t("EWl0"),v=t("tk/3"),D=t("ytdW"),C=t("I/3d");let y=(()=>{class e{constructor(e,s,t,n){this.datePipe=e,this.httpClient=s,this.tokenService=t,this.firestore=n}sendMessage(e,s,t){const n={msg:{message:s},sender:t,sentDate:this.datePipe.transform(new Date,"yyyy-MM-dd HH:mm:ss","TZD").toString()};this.firestore.collection("chat_rooms").doc(e).collection("messages").add(n)}requestGetMessages(e){if(e){let s;return console.log("getMessagesObservable is run"),function(e=0,s=d.a){return(!Object(m.a)(e)||e<0)&&(e=0),s&&"function"==typeof s.schedule||(s=d.a),new l.a(t=>(t.add(s.schedule(h,e,{subscriber:t,counter:0,period:e})),t))}(2e3).pipe(Object(u.a)(0),Object(b.a)(()=>this.firestore.collection("chat_rooms").doc(e).collection("messages").get().pipe(Object(p.a)(e=>(s||(console.log("size is undefined : ",s),this.chatMessages=new g.a(e)),console.log(s,e.size),e.size>s&&(console.log("there is new message"),this.chatMessages.next(e)),s=e.size,e)))))}}sendNotificationToReportFromAdmin(e){return this.httpClient.post(f.a.notificationToReportAPI,{roomID:e},this.tokenService.httpOptions())}sendNotificationToCaptainFromAdmin(e){return this.httpClient.post(f.a.notificationtoCaptainAPI,{roomID:e},this.tokenService.httpOptions())}notificationToOwnerFromAdmin(e){return this.httpClient.post(f.a.notificationToOwnerAPI,{roomID:e},this.tokenService.httpOptions())}}return e.\u0275fac=function(s){return new(s||e)(c.cc(i.e),c.cc(v.a),c.cc(D.a),c.cc(C.a))},e.\u0275prov=c.Pb({token:e,factory:e.\u0275fac,providedIn:"root"}),e})();var M=t("W9AH"),w=t("ijy7"),S=t("5eHb"),I=t("sYmb");function O(e,s){if(1&e&&(c.Wb(0),c.Yb(1,"p",12),c.Dc(2),c.Ub(3,"br"),c.Yb(4,"span",13),c.Dc(5),c.ic(6,"date"),c.Xb(),c.Xb(),c.Vb()),2&e){const e=c.hc().$implicit;c.Gb(2),c.Fc(" ",null!=e&&null!=e.msg&&e.msg.message?null==e||null==e.msg?null:e.msg.message:null==e?null:e.msg,""),c.Gb(3),c.Ec(c.kc(6,2,null!=e&&null!=e.sentDate&&e.sentDate.seconds?null==e||null==e.sentDate?null:e.sentDate.seconds:null==e?null:e.sentDate,"h:mm a"))}}function P(e,s){if(1&e&&(c.Wb(0),c.Yb(1,"p",14),c.Dc(2),c.Ub(3,"br"),c.Yb(4,"span",13),c.Dc(5),c.ic(6,"date"),c.Xb(),c.Xb(),c.Vb()),2&e){const e=c.hc().$implicit;c.Gb(2),c.Fc(" ",null!=e&&null!=e.msg&&e.msg.message?null==e||null==e.msg?null:e.msg.message:null==e?null:e.msg,""),c.Gb(3),c.Ec(c.kc(6,2,null!=e&&null!=e.sentDate&&e.sentDate.seconds?null==e||null==e.sentDate?null:e.sentDate.seconds:null==e?null:e.sentDate,"h:mm a"))}}function k(e,s){if(1&e&&(c.Wb(0),c.Cc(1,O,7,5,"ng-container",11),c.Cc(2,P,7,5,"ng-container",11),c.Vb()),2&e){const e=s.$implicit,t=c.hc();c.Gb(1),c.oc("ngIf",e.sender==t.secondSender),c.Gb(1),c.oc("ngIf",e.sender==t.firstSender)}}let x=(()=>{class e{constructor(e,s,t,n,o,i,r,c,l){this.messageService=e,this.captainService=s,this.orderService=t,this.ngZone=n,this.formBuilder=o,this.toaster=i,this.render=r,this.document=c,this.activatedRoute=l,this.destroy$=new a.a}ngOnInit(){this.isReportChat=!1,this.isCaptainChat=!1,this.checkMessageBodyScrollHeight(),this.messageForm=this.formBuilder.group({message:["",r.q.required],roomId:[""]}),this.activatedRoute.params.subscribe(e=>"owner"==e.client?(this.isOwnerChat=!0,this.roomID=e.uuid,this.runRequestGetMessages(e.uuid,this.ngZone),this.getMessages()):("captain"==e.client&&this.captainService.captainDetails(Number(e.id)).subscribe(e=>{if(console.log("Captain Room ID",e.Data.uuid),e.Data.uuid)return this.isCaptainChat=!0,this.roomID=e.Data.uuid,this.runRequestGetMessages(e.Data.uuid,this.ngZone),this.getMessages()}),"order"==e.client&&this.orderService.orderDetails(Number(e.id)).subscribe(e=>{if(e.Data.uuid)return console.log("Order Room ID : ",e.Data.uuid),this.roomID=e.Data.uuid,this.runRequestGetMessages(e.Data.uuid,this.ngZone),this.getMessages()}),"report"==e.client?(console.log("Report Room ID : ",e.uuid),this.isReportChat=!0,this.roomID=e.uuid,this.runRequestGetMessages(e.uuid,this.ngZone),this.getMessages()):void 0))}runRequestGetMessages(e,s){e&&(this.messageForm.get("roomId").setValue(e),s.runOutsideAngular(()=>{this.messageService.requestGetMessages(e).subscribe(e=>{console.log("data : ",e)})}))}getMessages(){const e=setInterval(()=>{this.messageService.chatMessages&&(clearInterval(e),this.messageService.chatMessages.subscribe(e=>{if(console.log("messages: ",e),e&&(this.messages=[],e.docs.forEach((e,s)=>{this.messages.push(e.data())}),this.messages.sort((e,s)=>e.sentDate.localeCompare(s.sentDate)),this.messages.length>0)){this.secondSender="admin";for(let e=0;e<this.messages.length;e++)null==this.firstSender&&this.messages[e].sender!=this.secondSender&&(this.firstSender=this.messages[e].sender)}},e=>console.log("Error ",e),()=>{if(this.messages.sort((e,s)=>e.sentDate.localeCompare(s.sentDate)),console.log("after sort Messages : ",this.messages),this.messages.length>0){this.secondSender="admin";for(let e=0;e<this.messages.length-1;e++)null==this.firstSender&&this.messages[e].sender!=this.secondSender&&(this.firstSender=this.messages[e].sender);console.log("firstSender : ",this.firstSender),console.log("secondSender : ",this.secondSender)}}))},1e3)}checkMessageBodyScrollHeight(){this.bodyScrollHeightInterval=setInterval(()=>{const e=this.document.querySelector(".messages-body");e.scrollHeight>40&&(e.scrollTop=e.scrollHeight,clearInterval(this.bodyScrollHeightInterval))},100)}checkMessageDirectionForRtl(){{const e=setInterval(()=>{const s=this.document.querySelector(".messages-body");s.scrollHeight>40&&(s.scrollTop=s.scrollHeight,clearInterval(e))},100)}}ngOnDestroy(){clearInterval(this.bodyScrollHeightInterval),this.isReportChat=!1,this.isCaptainChat=!1,this.isOwnerChat=!1,this.destroy$.next(),this.destroy$.complete()}onSubmit(){if(this.messageForm.valid){console.log("roomID : ",this.roomID);const e=this.messageForm.getRawValue();this.isReportChat&&this.messageService.sendNotificationToReportFromAdmin(this.roomID).subscribe(e=>console.log("send notification : ",e)),this.isCaptainChat&&this.messageService.sendNotificationToCaptainFromAdmin(this.roomID).subscribe(e=>console.log("send notification : ",e)),this.isOwnerChat&&this.messageService.notificationToOwnerFromAdmin(this.roomID).subscribe(e=>console.log("send notification : ",e)),console.log(e),e.roomId?this.messageService.sendMessage(e.roomId,e.message,"admin"):this.toaster.error("Error, Please Try Later"),this.messageForm.reset(),this.getMessages()}else this.toaster.error("Error : Can't Send An Empty Message")}}return e.\u0275fac=function(s){return new(s||e)(c.Tb(y),c.Tb(M.a),c.Tb(w.a),c.Tb(c.E),c.Tb(r.b),c.Tb(S.b),c.Tb(c.K),c.Tb(i.d),c.Tb(o.a))},e.\u0275cmp=c.Nb({type:e,selectors:[["app-chat"]],decls:17,vars:12,consts:[[1,"messages"],[1,"container"],[1,"bg-light-blue","text-white","font-weight-bold","p-3"],[1,"col-12","col-md-8","mx-auto","border","mt-4"],[1,"messages-body","my-3","pt-3","p-2"],[4,"ngFor","ngForOf"],[1,"",3,"formGroup","ngSubmit"],[1,"input-group","mb-3"],["type","text","name","message","formControlName","message","aria-label","Type here","aria-describedby","basic-addon2",1,"form-control",3,"placeholder"],[1,"input-group-append"],["type","submit",1,"btn","btn-primary",3,"disabled"],[4,"ngIf"],[1,"col-12","col-sm-11","col-md-10","recieved-message","text-white","py-1","px-2","rounded","bg-grey-blue","ml-custom-auto"],[1,"message-time"],[1,"col-12","col-sm-11","col-md-10","recieved-message","text-white","py-1","px-2","rounded","bg-light-blue","mr-custom-auto"]],template:function(e,s){1&e&&(c.Yb(0,"div",0),c.Yb(1,"div",1),c.Yb(2,"h1",2),c.Dc(3),c.ic(4,"translate"),c.Xb(),c.Yb(5,"div",3),c.Yb(6,"div",4),c.Cc(7,k,3,2,"ng-container",5),c.Xb(),c.Ub(8,"div"),c.Yb(9,"form",6),c.fc("ngSubmit",function(){return s.onSubmit()}),c.Yb(10,"div",7),c.Ub(11,"input",8),c.ic(12,"translate"),c.Yb(13,"div",9),c.Yb(14,"button",10),c.Dc(15),c.ic(16,"translate"),c.Xb(),c.Xb(),c.Xb(),c.Xb(),c.Xb(),c.Xb(),c.Xb()),2&e&&(c.Gb(3),c.Ec(c.jc(4,6,"chat-room")),c.Gb(4),c.oc("ngForOf",s.messages),c.Gb(2),c.oc("formGroup",s.messageForm),c.Gb(2),c.pc("placeholder",c.jc(12,8,"type-here")),c.Gb(3),c.oc("disabled",!s.messageForm.valid),c.Gb(1),c.Ec(c.jc(16,10,"send")))},directives:[i.l,r.s,r.i,r.f,r.a,r.h,r.d,i.m],pipes:[I.c,i.e],styles:["@media (min-width:992px) and (max-width:1199px){.messages[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{font-size:2.2rem}}@media (min-width:768px) and (max-width:991px){.messages[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{font-size:2rem}}@media (min-width:576px) and (max-width:767px){.messages[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{font-size:2rem;background:none!important;color:#21a5b8!important}}@media (max-width:575px){.messages[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{font-size:1.8rem;background:none!important;color:#21a5b8!important}}.messages-body[_ngcontent-%COMP%]{height:70vh;max-height:70vh;overflow-y:scroll;direction:ltr}.messages-body[_ngcontent-%COMP%]::-webkit-scrollbar{width:4px}.messages-body[_ngcontent-%COMP%]::-webkit-scrollbar-track{background:#f1f1f1}.messages-body[_ngcontent-%COMP%]::-webkit-scrollbar-thumb{background:#ccc}.messages-body[_ngcontent-%COMP%]::-webkit-scrollbar-thumb:hover{background:#aaa}.messages-body[_ngcontent-%COMP%]   .recieved-message[_ngcontent-%COMP%]{width:-webkit-max-content;width:max-content}.messages-body[_ngcontent-%COMP%]   .recieved-message[_ngcontent-%COMP%]   .message-time[_ngcontent-%COMP%]{font-size:.7rem;font-weight:100}"]}),e})();const G=[{path:"view/:client/:id",component:x},{path:"view/:client/:id/:uuid",component:x}];let T=(()=>{class e{}return e.\u0275mod=c.Rb({type:e}),e.\u0275inj=c.Qb({factory:function(s){return new(s||e)},imports:[[o.e.forChild(G)],o.e]}),e})(),R=(()=>{class e{}return e.\u0275mod=c.Rb({type:e}),e.\u0275inj=c.Qb({factory:function(s){return new(s||e)},providers:[y,i.e],imports:[[n.a,T]]}),e})()}}]);